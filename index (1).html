<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Session Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .video-container { aspect-ratio: 16/9; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .timer-overlay {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .recording-dot {
            animation: pulse 1s infinite;
        }
        .flicker {
            animation: flicker 0.1s infinite alternate;
        }
        @keyframes flicker {
            0% { opacity: 0.98; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="gradient-bg py-6 px-4 shadow-2xl">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-4xl">üçÖ</span>
                <div>
                    <h1 class="text-2xl font-bold">Pomodoro Session Simulator</h1>
                    <p class="text-sm text-white/70">Transform 30s clips into 1-hour timelapse sessions</p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 text-sm">
                <span class="px-3 py-1 bg-white/20 rounded-full">30s ‚Üí 60s</span>
                <span class="px-3 py-1 bg-white/20 rounded-full">Fake 1hr Timer</span>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Upload Section -->
        <section id="uploadSection" class="mb-8">
            <div class="glass rounded-2xl p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <span>üì§</span> Upload or Record Video
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- File Upload -->
                    <div class="border-2 border-dashed border-white/30 rounded-xl p-8 text-center hover:border-purple-400 transition-colors cursor-pointer" id="dropZone">
                        <input type="file" id="videoInput" accept="video/*" class="hidden">
                        <div class="text-5xl mb-4">üé¨</div>
                        <p class="font-medium mb-2">Drop your 30-second video here</p>
                        <p class="text-sm text-white/60 mb-4">or click to browse</p>
                        <button onclick="document.getElementById('videoInput').click()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                            Choose File
                        </button>
                    </div>

                    <!-- Webcam Recording -->
                    <div class="border-2 border-white/30 rounded-xl p-8 text-center">
                        <div class="text-5xl mb-4">üìπ</div>
                        <p class="font-medium mb-2">Record with Webcam</p>
                        <p class="text-sm text-white/60 mb-4">30-second auto-stop recording</p>
                        <button id="webcamBtn" onclick="startWebcam()" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                            Start Recording
                        </button>
                        <div id="recordingStatus" class="mt-4 hidden">
                            <div class="flex items-center justify-center gap-2">
                                <span class="w-3 h-3 bg-red-500 rounded-full recording-dot"></span>
                                <span id="recordingTime" class="mono">00:00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Webcam Preview -->
                <div id="webcamPreview" class="mt-6 hidden">
                    <video id="webcamVideo" autoplay muted class="w-full max-w-lg mx-auto rounded-xl"></video>
                </div>
            </div>
        </section>

        <!-- Processing Section -->
        <section id="processingSection" class="hidden mb-8">
            <div class="glass rounded-2xl p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> Customize Your Pomodoro Session
                </h2>

                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Preview Column -->
                    <div class="lg:col-span-2">
                        <div class="video-container bg-black rounded-xl overflow-hidden relative" id="previewContainer">
                            <video id="sourceVideo" class="absolute inset-0 w-full h-full object-contain" muted></video>
                            <canvas id="overlayCanvas" class="absolute inset-0 w-full h-full"></canvas>
                            
                            <!-- Overlay Preview Elements -->
                            <div id="overlayElements" class="absolute inset-0 pointer-events-none">
                                <!-- Timer -->
                                <div id="timerOverlay" class="absolute timer-overlay mono font-bold"></div>
                                
                                <!-- Phase Indicator -->
                                <div id="phaseOverlay" class="absolute timer-overlay"></div>
                                
                                <!-- Date/Time -->
                                <div id="dateOverlay" class="absolute timer-overlay text-sm"></div>
                                
                                <!-- Productivity Metrics -->
                                <div id="metricsOverlay" class="absolute timer-overlay text-sm hidden"></div>
                                
                                <!-- Recording Indicator -->
                                <div id="recIndicator" class="absolute top-4 right-4 flex items-center gap-2 hidden">
                                    <span class="w-3 h-3 bg-red-500 rounded-full recording-dot"></span>
                                    <span class="text-sm font-medium">REC</span>
                                </div>
                            </div>
                        </div>

                        <!-- Video Controls -->
                        <div class="mt-4 flex items-center gap-4">
                            <button id="playBtn" onclick="togglePlayback()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Preview
                            </button>
                            <button onclick="resetPreview()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">
                                üîÑ Reset
                            </button>
                            <div class="flex-1 mx-4">
                                <input type="range" id="progressSlider" min="0" max="100" value="0" class="w-full">
                            </div>
                            <span id="currentTimeDisplay" class="mono text-sm">00:00 / 01:00</span>
                        </div>

                        <!-- Simulated Timeline -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <div class="flex items-center justify-between text-xs text-white/60 mb-2">
                                <span>Simulated Timeline (1 Hour)</span>
                            </div>
                            <div class="h-8 bg-gray-700 rounded-lg overflow-hidden flex">
                                <div class="bg-red-500 flex-1 flex items-center justify-center text-xs">üçÖ Work 1</div>
                                <div class="bg-green-500 w-[8.33%] flex items-center justify-center text-xs">‚òï</div>
                                <div class="bg-red-500 flex-1 flex items-center justify-center text-xs">üçÖ Work 2</div>
                                <div class="bg-green-500 w-[8.33%] flex items-center justify-center text-xs">‚òï</div>
                            </div>
                            <div class="flex justify-between text-xs text-white/60 mt-1">
                                <span>0:00</span>
                                <span>25:00</span>
                                <span>30:00</span>
                                <span>55:00</span>
                                <span>60:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Column -->
                    <div class="space-y-6">
                        <!-- Timer Style -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>‚è±Ô∏è</span> Timer Style
                            </h3>
                            <select id="timerStyle" onchange="updateOverlaySettings()" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                                <option value="minimal">Minimal (00:25:30)</option>
                                <option value="detailed">Detailed (00:25:30.00)</option>
                                <option value="countdown">Pomodoro Countdown</option>
                            </select>
                            
                            <div class="mt-3">
                                <label class="text-sm text-white/70 block mb-1">Timer Position</label>
                                <select id="timerPosition" onchange="updateOverlaySettings()" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                                    <option value="top-left">Top Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="center-top">Center Top</option>
                                </select>
                            </div>

                            <div class="mt-3">
                                <label class="text-sm text-white/70 block mb-1">Timer Size</label>
                                <input type="range" id="timerSize" min="16" max="48" value="24" onchange="updateOverlaySettings()" class="w-full">
                            </div>
                        </div>

                        <!-- Start Time -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>üïê</span> Session Start Time
                            </h3>
                            <input type="time" id="startTime" value="09:00" onchange="updateOverlaySettings()" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                            
                            <div class="mt-3">
                                <label class="text-sm text-white/70 block mb-1">Date</label>
                                <input type="date" id="sessionDate" onchange="updateOverlaySettings()" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                            </div>
                        </div>

                        <!-- Color Theme -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>üé®</span> Color Theme
                            </h3>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setColorTheme('#ffffff')" class="w-10 h-10 rounded-lg bg-white border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#22c55e')" class="w-10 h-10 rounded-lg bg-green-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#ef4444')" class="w-10 h-10 rounded-lg bg-red-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#eab308')" class="w-10 h-10 rounded-lg bg-yellow-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#3b82f6')" class="w-10 h-10 rounded-lg bg-blue-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#a855f7')" class="w-10 h-10 rounded-lg bg-purple-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#f97316')" class="w-10 h-10 rounded-lg bg-orange-500 border-2 border-transparent hover:border-purple-400"></button>
                                <button onclick="setColorTheme('#06b6d4')" class="w-10 h-10 rounded-lg bg-cyan-500 border-2 border-transparent hover:border-purple-400"></button>
                            </div>
                        </div>

                        <!-- Activity Type -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>üìö</span> Activity Type
                            </h3>
                            <select id="activityType" onchange="updateOverlaySettings()" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                                <option value="coding">üíª Coding Session</option>
                                <option value="studying">üìñ Study Session</option>
                                <option value="writing">‚úçÔ∏è Writing Session</option>
                                <option value="drawing">üé® Art/Drawing Session</option>
                                <option value="reading">üìö Reading Session</option>
                                <option value="working">üíº Work Session</option>
                            </select>
                        </div>

                        <!-- Additional Options -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>‚ú®</span> Effects & Extras
                            </h3>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="showDate" checked onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Show Date/Time Stamp</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="showPhase" checked onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Show Phase Indicator</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="showMetrics" onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Show Productivity Metrics</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="showRecIndicator" onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Show REC Indicator</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="addFlicker" onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Add Timelapse Flicker</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="lightProgress" onchange="updateOverlaySettings()" class="w-4 h-4">
                                    <span class="text-sm">Simulate Lighting Changes</span>
                                </label>
                            </div>
                        </div>

                        <!-- Export Format -->
                        <div class="bg-gray-800 rounded-xl p-4">
                            <h3 class="font-medium mb-3 flex items-center gap-2">
                                <span>üì±</span> Export Format
                            </h3>
                            <select id="exportFormat" class="w-full bg-gray-700 rounded-lg p-2 text-sm">
                                <option value="original">Original Aspect Ratio</option>
                                <option value="square">Square (1:1) - Instagram</option>
                                <option value="portrait">Portrait (9:16) - TikTok/Reels</option>
                                <option value="landscape">Landscape (16:9) - YouTube</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Export Section -->
        <section id="exportSection" class="hidden mb-8">
            <div class="glass rounded-2xl p-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <span>üíæ</span> Export Your Video
                </h2>

                <div class="flex flex-wrap gap-4 items-center">
                    <button id="exportBtn" onclick="startExport()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-xl font-semibold text-lg transition-all transform hover:scale-105 flex items-center gap-2">
                        <span>üé¨</span> Export Video (60s)
                    </button>
                    
                    <button onclick="location.reload()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl transition-colors">
                        Start Over
                    </button>
                </div>

                <!-- Export Progress -->
                <div id="exportProgress" class="mt-6 hidden">
                    <div class="bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-sm text-white/60">
                        <span id="exportStatus">Processing...</span>
                        <span id="exportPercent">0%</span>
                    </div>
                </div>

                <!-- Download Section -->
                <div id="downloadSection" class="mt-6 hidden">
                    <div class="bg-green-600/20 border border-green-500 rounded-xl p-6 flex items-center gap-4">
                        <span class="text-4xl">‚úÖ</span>
                        <div class="flex-1">
                            <h3 class="font-semibold text-green-400">Export Complete!</h3>
                            <p class="text-sm text-white/70">Your 60-second Pomodoro timelapse is ready</p>
                        </div>
                        <a id="downloadLink" download="pomodoro-timelapse.webm" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-xl font-semibold transition-colors">
                            ‚¨áÔ∏è Download
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Info Section -->
        <section class="mb-8">
            <div class="glass rounded-2xl p-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <span>‚ÑπÔ∏è</span> How It Works
                </h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-3">1</div>
                        <h3 class="font-medium mb-1">Upload Video</h3>
                        <p class="text-sm text-white/60">Upload a 30-second clip or record with your webcam</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-3">2</div>
                        <h3 class="font-medium mb-1">Customize</h3>
                        <p class="text-sm text-white/60">Choose timer style, colors, and effects</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-3">3</div>
                        <h3 class="font-medium mb-1">Process</h3>
                        <p class="text-sm text-white/60">Video is stretched to 60s with fake 1-hour timer</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-3">4</div>
                        <h3 class="font-medium mb-1">Export</h3>
                        <p class="text-sm text-white/60">Download your convincing Pomodoro timelapse</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-white/40 text-sm">
        <p>üçÖ Pomodoro Session Simulator | For educational and entertainment purposes only</p>
    </footer>

    <script>
        // State
        let sourceVideo = null;
        let isPlaying = false;
        let animationId = null;
        let currentProgress = 0;
        let overlayColor = '#ffffff';
        let mediaRecorder = null;
        let recordedChunks = [];
        let webcamStream = null;

        // DOM Elements
        const videoInput = document.getElementById('videoInput');
        const sourceVideoEl = document.getElementById('sourceVideo');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        const progressSlider = document.getElementById('progressSlider');

        // Initialize
        document.getElementById('sessionDate').valueAsDate = new Date();

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-purple-400');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-purple-400');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-purple-400');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('video/')) {
                handleVideoFile(files[0]);
            }
        });

        // File Input
        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleVideoFile(e.target.files[0]);
            }
        });

        function handleVideoFile(file) {
            const url = URL.createObjectURL(file);
            sourceVideoEl.src = url;
            sourceVideoEl.load();
            sourceVideoEl.onloadedmetadata = () => {
                showProcessingSection();
            };
        }

        // Webcam Recording
        async function startWebcam() {
            const btn = document.getElementById('webcamBtn');
            
            if (webcamStream) {
                stopWebcam();
                return;
            }

            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const webcamVideo = document.getElementById('webcamVideo');
                webcamVideo.srcObject = webcamStream;
                document.getElementById('webcamPreview').classList.remove('hidden');
                
                btn.textContent = '‚èπÔ∏è Stop & Use';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');

                // Start recording
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(webcamStream);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    sourceVideoEl.src = url;
                    sourceVideoEl.load();
                    sourceVideoEl.onloadedmetadata = () => {
                        showProcessingSection();
                    };
                };

                mediaRecorder.start();
                
                // Show recording status
                document.getElementById('recordingStatus').classList.remove('hidden');
                let seconds = 0;
                const recordingInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('recordingTime').textContent = 
                        `${String(Math.floor(seconds / 60)).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
                    
                    if (seconds >= 30) {
                        clearInterval(recordingInterval);
                        stopWebcam();
                    }
                }, 1000);
                
                btn.recordingInterval = recordingInterval;

            } catch (err) {
                alert('Could not access webcam: ' + err.message);
            }
        }

        function stopWebcam() {
            const btn = document.getElementById('webcamBtn');
            
            if (btn.recordingInterval) {
                clearInterval(btn.recordingInterval);
            }
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            
            document.getElementById('webcamPreview').classList.add('hidden');
            document.getElementById('recordingStatus').classList.add('hidden');
            
            btn.textContent = 'Start Recording';
            btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            btn.classList.add('bg-red-600', 'hover:bg-red-700');
        }

        function showProcessingSection() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('exportSection').classList.remove('hidden');
            
            // Setup canvas size
            canvas.width = sourceVideoEl.videoWidth || 1280;
            canvas.height = sourceVideoEl.videoHeight || 720;
            
            updateOverlaySettings();
        }

        function updateOverlaySettings() {
            const timerStyle = document.getElementById('timerStyle').value;
            const timerPosition = document.getElementById('timerPosition').value;
            const timerSize = document.getElementById('timerSize').value;
            const showDate = document.getElementById('showDate').checked;
            const showPhase = document.getElementById('showPhase').checked;
            const showMetrics = document.getElementById('showMetrics').checked;
            const showRecIndicator = document.getElementById('showRecIndicator').checked;
            const addFlicker = document.getElementById('addFlicker').checked;

            // Timer position
            const timerEl = document.getElementById('timerOverlay');
            timerEl.className = 'absolute timer-overlay mono font-bold';
            timerEl.style.fontSize = timerSize + 'px';
            timerEl.style.color = overlayColor;
            
            const positions = {
                'top-left': 'top-4 left-4',
                'top-right': 'top-4 right-4',
                'bottom-left': 'bottom-4 left-4',
                'bottom-right': 'bottom-4 right-4',
                'center-top': 'top-4 left-1/2 -translate-x-1/2'
            };
            timerEl.className += ' ' + positions[timerPosition];

            // Phase indicator
            const phaseEl = document.getElementById('phaseOverlay');
            phaseEl.style.display = showPhase ? 'block' : 'none';
            phaseEl.style.color = overlayColor;
            phaseEl.className = 'absolute timer-overlay bottom-4 left-4 text-lg font-semibold';

            // Date overlay
            const dateEl = document.getElementById('dateOverlay');
            dateEl.style.display = showDate ? 'block' : 'none';
            dateEl.style.color = overlayColor;
            dateEl.className = 'absolute timer-overlay top-4 left-1/2 -translate-x-1/2 text-sm';

            // Metrics overlay
            const metricsEl = document.getElementById('metricsOverlay');
            metricsEl.style.display = showMetrics ? 'block' : 'none';
            metricsEl.style.color = overlayColor;
            metricsEl.className = 'absolute timer-overlay bottom-4 right-4 text-sm text-right';

            // REC indicator
            document.getElementById('recIndicator').style.display = showRecIndicator ? 'flex' : 'none';

            // Flicker effect
            const container = document.getElementById('previewContainer');
            if (addFlicker) {
                container.classList.add('flicker');
            } else {
                container.classList.remove('flicker');
            }

            updateOverlayContent(currentProgress);
        }

        function setColorTheme(color) {
            overlayColor = color;
            updateOverlaySettings();
        }

        function getPhaseInfo(simulatedMinutes) {
            const activityType = document.getElementById('activityType').value;
            const activities = {
                'coding': 'üíª Coding',
                'studying': 'üìñ Studying', 
                'writing': '‚úçÔ∏è Writing',
                'drawing': 'üé® Drawing',
                'reading': 'üìö Reading',
                'working': 'üíº Working'
            };
            const activity = activities[activityType] || 'Work';

            if (simulatedMinutes < 25) {
                return { phase: `üçÖ ${activity} - Session 1`, isBreak: false };
            } else if (simulatedMinutes < 30) {
                return { phase: '‚òï Break Time', isBreak: true };
            } else if (simulatedMinutes < 55) {
                return { phase: `üçÖ ${activity} - Session 2`, isBreak: true };
            } else {
                return { phase: '‚òï Final Break', isBreak: true };
            }
        }

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const timerStyle = document.getElementById('timerStyle').value;

            if (timerStyle === 'detailed') {
                const ms = Math.floor((totalSeconds % 1) * 100);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(2, '0')}`;
            } else if (timerStyle === 'countdown') {
                const remaining = 3600 - totalSeconds;
                const remMin = Math.floor(remaining / 60);
                const remSec = Math.floor(remaining % 60);
                return `${String(remMin).padStart(2, '0')}:${String(remSec).padStart(2, '0')} remaining`;
            }
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateOverlayContent(progress) {
            // progress is 0-100, representing 0-60 seconds of output video
            // Simulated time: 0-3600 seconds (1 hour)
            const simulatedSeconds = (progress / 100) * 3600;
            const simulatedMinutes = simulatedSeconds / 60;

            // Update timer
            document.getElementById('timerOverlay').textContent = formatTime(simulatedSeconds);

            // Update phase
            const phaseInfo = getPhaseInfo(simulatedMinutes);
            document.getElementById('phaseOverlay').textContent = phaseInfo.phase;

            // Update date/time
            const startTime = document.getElementById('startTime').value;
            const sessionDate = document.getElementById('sessionDate').value;
            const [startHour, startMin] = startTime.split(':').map(Number);
            const currentHour = startHour + Math.floor(simulatedMinutes / 60);
            const currentMin = (startMin + Math.floor(simulatedMinutes)) % 60;
            const dateObj = new Date(sessionDate);
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('dateOverlay').textContent = 
                `${dateStr} | ${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;

            // Update metrics
            const tasksCompleted = Math.floor(simulatedMinutes / 15);
            const focusPercent = Math.min(95, 75 + Math.floor(progress / 5));
            document.getElementById('metricsOverlay').innerHTML = 
                `‚úÖ Tasks: ${tasksCompleted}<br>üéØ Focus: ${focusPercent}%`;

            // Update time display
            const outputSeconds = (progress / 100) * 60;
            document.getElementById('currentTimeDisplay').textContent = 
                `${String(Math.floor(outputSeconds / 60)).padStart(2, '0')}:${String(Math.floor(outputSeconds % 60)).padStart(2, '0')} / 01:00`;
        }

        function togglePlayback() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
            
            // Play video at 0.5x speed (30s becomes 60s)
            sourceVideoEl.playbackRate = 0.5;
            sourceVideoEl.play();

            function animate() {
                if (!isPlaying) return;

                const videoDuration = sourceVideoEl.duration || 30;
                const currentTime = sourceVideoEl.currentTime;
                // Output progress: currentTime at 0.5x speed means output time = currentTime * 2
                // But we want 60s total output, so progress = (currentTime / videoDuration) * 100
                currentProgress = (currentTime / videoDuration) * 100;
                
                progressSlider.value = currentProgress;
                updateOverlayContent(currentProgress);

                // Apply lighting changes if enabled
                if (document.getElementById('lightProgress').checked) {
                    const brightness = 0.9 + (currentProgress / 100) * 0.2;
                    sourceVideoEl.style.filter = `brightness(${brightness})`;
                } else {
                    sourceVideoEl.style.filter = '';
                }

                if (currentTime >= videoDuration - 0.1) {
                    pausePlayback();
                    return;
                }

                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function pausePlayback() {
            isPlaying = false;
            sourceVideoEl.pause();
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Preview';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function resetPreview() {
            pausePlayback();
            sourceVideoEl.currentTime = 0;
            currentProgress = 0;
            progressSlider.value = 0;
            updateOverlayContent(0);
        }

        progressSlider.addEventListener('input', (e) => {
            currentProgress = parseFloat(e.target.value);
            const videoDuration = sourceVideoEl.duration || 30;
            sourceVideoEl.currentTime = (currentProgress / 100) * videoDuration;
            updateOverlayContent(currentProgress);
        });

        // Export functionality
        async function startExport() {
            const exportBtn = document.getElementById('exportBtn');
            const exportProgress = document.getElementById('exportProgress');
            const progressBar = document.getElementById('progressBar');
            const exportStatus = document.getElementById('exportStatus');
            const exportPercent = document.getElementById('exportPercent');
            const downloadSection = document.getElementById('downloadSection');

            exportBtn.disabled = true;
            exportBtn.textContent = '‚è≥ Processing...';
            exportProgress.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            // Create offscreen canvas for rendering
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            
            // Set export dimensions based on format
            const format = document.getElementById('exportFormat').value;
            let exportWidth, exportHeight;
            
            switch(format) {
                case 'square':
                    exportWidth = exportHeight = 1080;
                    break;
                case 'portrait':
                    exportWidth = 1080;
                    exportHeight = 1920;
                    break;
                case 'landscape':
                default:
                    exportWidth = 1920;
                    exportHeight = 1080;
            }
            
            exportCanvas.width = exportWidth;
            exportCanvas.height = exportHeight;

            // Setup MediaRecorder
            const stream = exportCanvas.captureStream(30);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            const chunks = [];

            recorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                document.getElementById('downloadLink').href = url;
                
                exportBtn.disabled = false;
                exportBtn.textContent = 'üé¨ Export Video (60s)';
                downloadSection.classList.remove('hidden');
                exportStatus.textContent = 'Complete!';
            };

            // Start recording
            recorder.start();
            sourceVideoEl.currentTime = 0;
            sourceVideoEl.playbackRate = 0.5;
            await sourceVideoEl.play();

            const videoDuration = sourceVideoEl.duration || 30;
            const totalFrames = 60 * 30; // 60 seconds at 30fps
            let frameCount = 0;

            function renderFrame() {
                const currentTime = sourceVideoEl.currentTime;
                const progress = (currentTime / videoDuration) * 100;
                
                // Update progress UI
                progressBar.style.width = progress + '%';
                exportPercent.textContent = Math.floor(progress) + '%';
                exportStatus.textContent = `Rendering frame ${frameCount}...`;

                // Clear and draw video
                exportCtx.fillStyle = '#000';
                exportCtx.fillRect(0, 0, exportWidth, exportHeight);

                // Calculate video positioning
                const videoAspect = sourceVideoEl.videoWidth / sourceVideoEl.videoHeight;
                const canvasAspect = exportWidth / exportHeight;
                let drawWidth, drawHeight, drawX, drawY;

                if (videoAspect > canvasAspect) {
                    drawWidth = exportWidth;
                    drawHeight = exportWidth / videoAspect;
                    drawX = 0;
                    drawY = (exportHeight - drawHeight) / 2;
                } else {
                    drawHeight = exportHeight;
                    drawWidth = exportHeight * videoAspect;
                    drawX = (exportWidth - drawWidth) / 2;
                    drawY = 0;
                }

                // Apply brightness if enabled
                if (document.getElementById('lightProgress').checked) {
                    const brightness = 0.9 + (progress / 100) * 0.2;
                    exportCtx.filter = `brightness(${brightness})`;
                }
                
                exportCtx.drawImage(sourceVideoEl, drawX, drawY, drawWidth, drawHeight);
                exportCtx.filter = 'none';

                // Draw overlays
                const simulatedSeconds = (progress / 100) * 3600;
                const simulatedMinutes = simulatedSeconds / 60;
                const timerSize = parseInt(document.getElementById('timerSize').value) * 2;

                exportCtx.fillStyle = overlayColor;
                exportCtx.font = `bold ${timerSize}px "JetBrains Mono", monospace`;
                exportCtx.textBaseline = 'top';
                
                // Add text shadow
                exportCtx.shadowColor = 'rgba(0,0,0,0.8)';
                exportCtx.shadowBlur = 4;
                exportCtx.shadowOffsetX = 2;
                exportCtx.shadowOffsetY = 2;

                // Timer
                const timerText = formatTime(simulatedSeconds);
                const timerPosition = document.getElementById('timerPosition').value;
                let timerX = 40, timerY = 40;
                
                if (timerPosition.includes('right')) timerX = exportWidth - exportCtx.measureText(timerText).width - 40;
                if (timerPosition.includes('bottom')) timerY = exportHeight - timerSize - 40;
                if (timerPosition.includes('center')) timerX = (exportWidth - exportCtx.measureText(timerText).width) / 2;
                
                exportCtx.fillText(timerText, timerX, timerY);

                // Phase indicator
                if (document.getElementById('showPhase').checked) {
                    const phaseInfo = getPhaseInfo(simulatedMinutes);
                    exportCtx.font = `bold ${timerSize * 0.7}px "Inter", sans-serif`;
                    exportCtx.fillText(phaseInfo.phase, 40, exportHeight - 60);
                }

                // Date/time
                if (document.getElementById('showDate').checked) {
                    const startTime = document.getElementById('startTime').value;
                    const sessionDate = document.getElementById('sessionDate').value;
                    const [startHour, startMin] = startTime.split(':').map(Number);
                    const currentHour = startHour + Math.floor(simulatedMinutes / 60);
                    const currentMin = (startMin + Math.floor(simulatedMinutes)) % 60;
                    const dateObj = new Date(sessionDate);
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    exportCtx.font = `${timerSize * 0.5}px "Inter", sans-serif`;
                    const dateText = `${dateStr} | ${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
                    exportCtx.fillText(dateText, (exportWidth - exportCtx.measureText(dateText).width) / 2, 40);
                }

                // Metrics
                if (document.getElementById('showMetrics').checked) {
                    const tasksCompleted = Math.floor(simulatedMinutes / 15);
                    const focusPercent = Math.min(95, 75 + Math.floor(progress / 5));
                    exportCtx.font = `${timerSize * 0.5}px "Inter", sans-serif`;
                    exportCtx.textAlign = 'right';
                    exportCtx.fillText(`‚úÖ Tasks: ${tasksCompleted}`, exportWidth - 40, exportHeight - 80);
                    exportCtx.fillText(`üéØ Focus: ${focusPercent}%`, exportWidth - 40, exportHeight - 50);
                    exportCtx.textAlign = 'left';
                }

                // REC indicator
                if (document.getElementById('showRecIndicator').checked) {
                    exportCtx.fillStyle = '#ef4444';
                    exportCtx.beginPath();
                    exportCtx.arc(exportWidth - 80, 50, 10, 0, Math.PI * 2);
                    exportCtx.fill();
                    exportCtx.fillStyle = overlayColor;
                    exportCtx.font = `bold ${timerSize * 0.5}px "Inter", sans-serif`;
                    exportCtx.fillText('REC', exportWidth - 60, 40);
                }

                exportCtx.shadowColor = 'transparent';
                frameCount++;

                if (currentTime < videoDuration - 0.1) {
                    requestAnimationFrame(renderFrame);
                } else {
                    sourceVideoEl.pause();
                    recorder.stop();
                }
            }

            renderFrame();
        }
    </script>
</body>
</html>
